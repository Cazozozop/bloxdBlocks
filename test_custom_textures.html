<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Test Exceptions BloxdBlocks (fix)</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #1a1a1a;
    color: #fff;
    text-align: center;
    padding: 30px;
  }
  input {
    font-size: 18px;
    padding: 10px;
    border-radius: 8px;
    border: none;
    width: 80%;
    max-width: 400px;
    margin-bottom: 20px;
  }
  .result {
    margin-top: 20px;
  }
  img {
    image-rendering: pixelated;
    width: 96px;
    height: 96px;
    margin: 5px;
    border-radius: 6px;
    background: #333;
  }
  .error {
    color: #ff6b6b;
  }
</style>
</head>
<body>
<h1>üîç Test Exceptions BloxdBlocks</h1>
<input type="text" id="search" placeholder="Tape un nom de bloc...">
<div class="result" id="result">Chargement...</div>

<script>
const BASE_URL = "https://raw.githubusercontent.com/Cazozozop/bloxdBlocks/main/";
const EXCEPTIONS_URL = BASE_URL + "exceptions.txt";
const TEXTURE_PATH = BASE_URL + "exceptions/";

async function loadExceptions() {
  const resultEl = document.getElementById("result");
  resultEl.innerHTML = "Chargement des exceptions...";
  try {
    const res = await fetch(EXCEPTIONS_URL);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith("//"));
    const out = {};

    for (const line of lines) {
      // Exemple : "lava"="lava_1","lava_2","lava_3":200
      const match = line.match(/^"([^"]+)"="?([^:"]+.*?)(?::(\d+))?$/);
      if (!match) continue;

      const name = match[1].trim();
      const texList = match[2].split(",").map(t => t.replace(/"/g, '').trim());
      const interval = match[3] ? parseInt(match[3]) : 0;

      out[name] = { textures: texList, interval };
    }

    const count = Object.keys(out).length;
    resultEl.innerHTML = `‚úÖ Exceptions charg√©es (${count})`;
    return out;
  } catch (err) {
    resultEl.innerHTML = `<span class='error'>‚ùå Erreur: ${err.message}</span>`;
    return {};
  }
}

let exceptions = {};
(async () => {
  exceptions = await loadExceptions();
})();

document.getElementById("search").addEventListener("input", e => {
  const val = e.target.value.trim();
  const resultEl = document.getElementById("result");

  if (!val) {
    resultEl.innerHTML = "Tape un nom de bloc...";
    return;
  }

  const found = exceptions[val];
  if (!found) {
    resultEl.innerHTML = `<span class='error'>Aucune exception trouv√©e pour <b>${val}</b>.</span>`;
    return;
  }

  let html = `<h2>${val}</h2>`;
  html += `<p>Textures : ${found.textures.join(", ")}</p>`;
  if (found.interval) html += `<p>Animation : ${found.interval} ms</p>`;

  for (const tex of found.textures) {
    const url = TEXTURE_PATH + tex + ".png";
    html += `<img src="${url}" alt="${tex}" onerror="this.style.display='none'">`;
  }

  // Animation si plusieurs textures
  if (found.textures.length > 1 && found.interval > 0) {
    html += `<p>(Animation active üîÅ)</p>`;
    setTimeout(() => animateTextures(found.textures, found.interval), 200);
  }

  resultEl.innerHTML = html;
});

function animateTextures(textures, interval) {
  const imgs = document.querySelectorAll(".result img");
  let idx = 0;
  setInterval(() => {
    idx = (idx + 1) % textures.length;
    imgs.forEach(img => img.src = TEXTURE_PATH + textures[idx] + ".png");
  }, interval);
}
</script>
</body>
</html>
